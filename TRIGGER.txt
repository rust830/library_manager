DELIMITER $$
CREATE TRIGGER AFTER_BORROW
AFTER INSERT ON mutifunctionallogs FOR EACH ROW 
BEGIN 
IF NEW.return_date IS NULL THEN 
UPDATE USER 
SET CURRENT_BORROWED=CURRENT_BORROWED+1
WHERE USER_ID=NEW.USER_ID;

UPDATE copy
SET STATU='CHECK_OUT'
WHERE COPY_ID=NEW.COPY_ID;
END IF;
END$$
DELIMITER;//更新图书状态

DELIMITER $$
CREATE TRIGGER AFTER_RETURN
AFTER UPDATE ON mutifunctionallogs FOR EACH ROW
BEGIN 
IF OLD.return_date IS NULL AND NEW.return_date IS NOT NULL THEN 
UPDATE users
SET CURRENT_BORROWED=CURRENT_BORROWED-1
WHERE USER_ID=NEW.USER_ID;

UPDATE copy
SET STATU='AVAILABLE'
WHERE COPY_ID=OLD.COPY_ID;
END IF;
END$$
DELIMITER;  //更新图书状态

DELIMITER$$
CREATE TRIGGER FINE_COUNTER
AFTER UPDATE ON mutifunctionallogs FOR EACH ROW 
BEGIN 
DECLARE MAX_DAYS INT ;
DECLARE USER_TYPES VARCHAR(20);  
DECLARE DAYS INT;
DECLARE DAYSDIFF INT;
DECLARE NFINE DECIMAL(10,2);
DECLARE FINE_PERDAY DECIMAL(5,2);
IF OLD.return_date IS NULL AND NEW.return_date IS NOT NULL THEN

SELECT users.USER_TYPE INTO USER_TYPES
FROM users
WHERE users.USER_ID=NEW.USER_ID;

SELECT MAX_INT,FINE_PER_DAY INTO MAX_DAYS,FINE_PERDAY
FROM borrow_rules
WHERE USER_TYPE=USER_TYPES;

SET DAYS=DATEDIFF(NEW.return_date,NEW.BORROW_DATE);
SET DAYSDIFF=GREATEST(0,DAYS-MAX_INT);
SET NFINE=FINE_PERDAY*DAYSDIFF;

UPDATE users
SET FINE=FINE+NFINE
WHERE USER_ID=NEW.USER_ID;
  END IF;

END$$

DELIMITER ;//计算罚款

